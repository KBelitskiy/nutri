# NutriBot — Телеграм-бот нутрициолог

## 1. Описание проекта

Персональный Telegram-бот для трекинга питания и нутрициологических консультаций. Бот помогает пользователю отслеживать ежедневный рацион, считать калории и КБЖУ, ставить цели и получать рекомендации по питанию. В качестве интеллектуального ядра используется OpenAI API.

---

## 2. Функциональные требования

### 2.1. Онбординг пользователя
- При первом запуске бот проводит анкетирование: пол, возраст, рост, текущий вес, уровень физической активности
- Пользователь выбирает цель: **похудеть / поддерживать вес / набрать массу**
- На основе введённых данных бот рассчитывает суточную норму калорий и КБЖУ (формула Миффлина-Сан Жеора или аналогичная)
- Пользователь может в любой момент обновить свои параметры и цели

### 2.2. Логирование приёмов пищи
- Ввод блюд **текстом**: пользователь описывает что съел, бот через ИИ оценивает калорийность и КБЖУ
- Ввод блюд **фото**: пользователь отправляет фото еды, бот через Vision API распознаёт блюдо и оценивает нутриенты
- После каждого ввода бот возвращает:
  - Оценку калорийности и КБЖУ блюда
  - Процент от суточной нормы (сколько уже употреблено за сегодня)
  - Остаток калорий и КБЖУ до конца дня
- Пользователь может отредактировать или удалить ошибочно залогированный приём пищи

### 2.3. Трекинг веса
- Бот хранит стартовый вес (из онбординга) и историю всех взвешиваний
- Пользователь может в любой момент ввести текущий вес
- Бот показывает динамику веса (разница со стартовым, тренд за период)

### 2.4. Статистика и аналитика
- По запросу бот предоставляет статистику питания за выбранный период (день / неделя / месяц / произвольный)
- Статистика включает: среднее потребление калорий, КБЖУ, процент выполнения целей
- Бот анализирует рацион и даёт персонализированные рекомендации (недобор белка, перебор жиров и т.д.)
- Визуализация данных: графики и сводки в текстовом или графическом формате

### 2.5. Рекомендации по питанию
- Бот видит текущий процент суточного потребления и может предложить, чем «добить» норму калорий и КБЖУ
- Рекомендации учитывают предпочтения пользователя и ранее залогированные блюда
- Бот может отвечать на произвольные вопросы по питанию, диетологии, нутрициологии

### 2.6. Напоминания и мотивация
- Настраиваемые напоминания о приёмах пищи (завтрак, обед, ужин, перекусы)
- Напоминание о вводе веса (например, раз в неделю)
- Мотивационные сообщения при достижении целей или стриков (N дней подряд в рамках нормы)

---

## 3. User Stories

| # | Роль | Действие | Результат |
|---|------|----------|-----------|
| 1 | Пользователь | Запускаю бота впервые | Прохожу онбординг, получаю суточные цели по калориям и КБЖУ |
| 2 | Пользователь | Отправляю текст «съел греческий салат и куриную грудку 200г» | Получаю оценку калорий/КБЖУ блюда + текущий прогресс за день |
| 3 | Пользователь | Отправляю фото тарелки с едой | Бот распознаёт блюдо, оценивает нутриенты, обновляет дневной прогресс |
| 4 | Пользователь | Прошу показать статистику за неделю | Получаю сводку: ср. калораж, КБЖУ, % выполнения целей, рекомендации |
| 5 | Пользователь | Ввожу текущий вес | Бот фиксирует вес, показывает динамику относительно стартового |
| 6 | Пользователь | Спрашиваю «чем добить 400 ккал до нормы?» | Бот предлагает варианты перекусов/блюд с учётом оставшихся КБЖУ |
| 7 | Пользователь | Задаю вопрос «какие продукты богаты железом?» | Бот отвечает как нутрициолог, используя знания ИИ |
| 8 | Пользователь | Хочу удалить залогированный приём пищи | Бот позволяет выбрать и удалить запись, пересчитывает дневной итог |
| 9 | Пользователь | Хочу сбросить все свои данные | Нажимаю кнопку в меню, бот просит подтверждение и удаляет данные |

---

## 4. Технические требования

### 4.1. Архитектура
- **Агентная архитектура** на базе OpenAI API (function calling / tool use)
- Агент имеет набор инструментов (tools) для:
  - Записи/чтения приёмов пищи из БД
  - Получения статистики за период
  - Расчёта суточных норм
  - Анализа фото через Vision API
  - Получения данных о весе пользователя
- Системный промпт задаёт роль нутрициолога и правила поведения

### 4.2. Стек технологий
- **Язык**: Python 3.11+
- **Telegram API**: `aiogram 3.x` (асинхронный фреймворк)
- **ИИ**: OpenAI API (`gpt-4o` для текста и vision, function calling для tools)
- **База данных**: SQLite (для простоты) или PostgreSQL (для продакшена)
- **ORM**: SQLAlchemy или простой слой через `aiosqlite`
- **Конфигурация**: переменные окружения через `.env` файл (`python-dotenv`)

### 4.3. Хранение данных
- Все данные каждого пользователя хранятся **персистентно** в БД на сервере
- Данные **не стираются** при перезапуске бота
- Удаление данных — только по явному запросу пользователя через меню бота (с подтверждением)
- Каждый пользователь имеет изолированный контекст (данные одного пользователя недоступны другому)

### 4.4. Модель данных (основные сущности)

```
users
├── telegram_id (PK)
├── username
├── gender
├── age
├── height_cm
├── weight_start_kg
├── activity_level
├── goal (lose / maintain / gain)
├── daily_calories_target
├── daily_protein_target
├── daily_fat_target
├── daily_carbs_target
├── created_at
└── updated_at

weight_logs
├── id (PK)
├── telegram_id (FK → users)
├── weight_kg
└── logged_at

meal_logs
├── id (PK)
├── telegram_id (FK → users)
├── description
├── calories
├── protein_g
├── fat_g
├── carbs_g
├── photo_file_id (nullable)
├── meal_type (breakfast / lunch / dinner / snack)
└── logged_at
```

### 4.5. Безопасность и ограничения
- Токены Telegram-бота и OpenAI хранятся в `.env`, не коммитятся в репозиторий
- Rate limiting: ограничение частоты запросов к OpenAI на пользователя
- Валидация всех пользовательских входных данных
- Graceful handling ошибок API (OpenAI недоступен, превышен лимит и т.д.)

---

## 5. Структура проекта (предварительная)

```
nutri/
├── bot/
│   ├── __init__.py
│   ├── main.py              # Точка входа, запуск бота
│   ├── config.py             # Конфигурация (env vars)
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── start.py          # /start, онбординг
│   │   ├── meal.py           # Логирование приёмов пищи
│   │   ├── weight.py         # Ввод веса
│   │   ├── stats.py          # Статистика
│   │   └── settings.py       # Настройки, удаление данных
│   ├── services/
│   │   ├── __init__.py
│   │   ├── ai_agent.py       # Агент OpenAI с tools
│   │   ├── nutrition.py      # Расчёт норм, КБЖУ
│   │   └── vision.py         # Распознавание фото еды
│   ├── database/
│   │   ├── __init__.py
│   │   ├── models.py         # SQLAlchemy модели
│   │   ├── connection.py     # Подключение к БД
│   │   └── crud.py           # CRUD операции
│   └── tools/
│       ├── __init__.py
│       ├── meal_tools.py     # Tools для агента: работа с приёмами пищи
│       ├── stats_tools.py    # Tools для агента: статистика
│       ├── user_tools.py     # Tools для агента: данные пользователя
│       └── weight_tools.py   # Tools для агента: вес
├── .env.example
├── .gitignore
├── requirements.txt
├── task.md
└── README.md
```

---

## 6. Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Запуск бота, онбординг нового пользователя |
| `/profile` | Просмотр/редактирование профиля и целей |
| `/today` | Сводка за сегодня: съедено / осталось |
| `/stats` | Статистика за период (неделя по умолчанию) |
| `/weight` | Ввести текущий вес |
| `/history` | История приёмов пищи за сегодня (с возможностью удалить) |
| `/suggest` | Предложить чем добить дневную норму |
| `/reset` | Удалить все данные (с подтверждением) |
| `/help` | Справка по командам |

---

## 7. Приоритеты реализации (MVP → Full)

### MVP (Phase 1)
- [ ] Онбординг (анкета + расчёт целей)
- [ ] Логирование еды текстом + оценка КБЖУ через OpenAI
- [ ] Дневной прогресс (съедено / осталось)
- [ ] Хранение данных в SQLite
- [ ] Базовые команды: `/start`, `/today`, `/help`

### Phase 2
- [ ] Распознавание еды по фото (Vision API)
- [ ] Статистика за период
- [ ] Трекинг веса
- [ ] Редактирование/удаление приёмов пищи
- [ ] Команды: `/stats`, `/weight`, `/history`

### Phase 3
- [ ] Рекомендации по добиванию нормы
- [ ] Аналитика рациона с советами
- [ ] Напоминания
- [ ] Rate limiting и продвинутая обработка ошибок
- [ ] Миграция на PostgreSQL (опционально)

Проект бота должен быть сделан так чтобы его легко можно было развернуть в amvera 